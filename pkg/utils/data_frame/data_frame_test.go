package dataframe

import (
	"testing"
)

func Test_GrafanaDataFramesToTable(t *testing.T) {
	t.Run("array with formattime", func(t *testing.T) {
		timeSchema := `[{"schema":{"fields":[{"name":"Time","type":"time"},{"name":"Value","type":"number"}],"name":"7天成功率"},"data":{"values":[[1757307600000,1757311200000,1757314800000],[0.990006885342176,0.990006885342176,0.990006885342176]]}}]`

		converted := ToTable(timeSchema, WithFormatTime())
		expected := `[{"name":"7天成功率","Data":[["Time","Value"],["2025-09-08T13:00:00+08:00",0.990006885342176],["2025-09-08T14:00:00+08:00",0.990006885342176],["2025-09-08T15:00:00+08:00",0.990006885342176]]}]`
		if converted != expected {
			t.Error("GrafanaDataFramesToTable return not expected")
		}
	})

	t.Run("trace", func(t *testing.T) {
		trace := `{"schema":{"fields":[{"name":"traceID","type":"string"},{"name":"spanID","type":"string"},{"name":"parentSpanID","type":"string"},{"name":"operationName","type":"string"},{"name":"serviceName","type":"string"},{"name":"serviceTags","type":"string"},{"name":"startTime","type":"time"},{"name":"duration","type":"number"}]},"data":{"values":[["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41"],["bbad2b91-5afd-4b15-9958-b3a0be435cd0","81f5a0e2-758e-40ec-b84e-06cad40c259f","89da31de-c51a-43b5-9073-3355608cc026","c422c90f-ad7b-4813-b265-16f6b611e09c","3561536f-6e6e-423c-af83-97fd868a43fe","7ac8d072-1674-4cc0-8013-392a865e1460","ce698f1d-b00a-403b-a42a-eada67cc3cfe","b9456e72-4f1f-4915-ad23-e8b587efe3f8","42a1b193-054d-4856-b2c6-a06b75d02791","ab0993e1-aa0c-4d71-b6a1-ee116c53cfbe","9fdb933e-91fb-4400-aebe-355d46f30dcc","3e643e5c-608a-4f1f-b41b-71b2acf3cb99","bff4b56f-d062-4825-ba17-b32834bd9986","a78db90d-0c79-4190-acc8-f47c9538e2c6","3438e9d2-2b95-4fc9-af6f-7ca784a72baa","b52c6728-8b61-4867-b564-b8e05fec1478","8093ebb4-ff37-4b0b-a883-52c308870db2","7ef50aa2-9d77-4b72-b926-d9b838ffdd8f","57cf2d0b-a751-4235-8d13-38613998be64","b074099f-286d-414f-9097-9222fe0004de","1c76a6ae-156a-463c-b683-6144986987ed","35e9abd7-fbc4-45cc-8480-8b3a39de5e1c","c1097be4-01c4-47c8-9f8c-18b395a99775","0531cafc-1459-4c3c-ae30-3afbd6c4dc71","f1aa3973-ad51-43ea-80b5-944041c69263","807bc597-49e9-4d0d-87d9-080e7cc0b672","2b273128-14fe-40b2-bda5-6a63a020b1df"],[null,"bbad2b91-5afd-4b15-9958-b3a0be435cd0","81f5a0e2-758e-40ec-b84e-06cad40c259f","bbad2b91-5afd-4b15-9958-b3a0be435cd0","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c"],["PodDelivery","pod_delete_span","kubelet_delete_span","pod_ready_span","sandbox_create_span","container_kill_span:test-bvt-container-lvcsuv1v-eu126","ip_allocate_span","pod_running_span","default_schedule_span","container_start_span:test-bvt-container-lvcsuv1v-eu126","container_create_span:test-bvt-container-lvcsuv1v-eu126","ip_release_span","kubelet_delay_span","finalizer_delete_span:finalizer.k8s.alipay.com/zappinfo","volume_mount_span:default-token-8f4l2","finalizer_delete_span:finalizers.k8s.alipay.com/pod-fqdn","volume_mount_span:shm1","volume_mount_span:shm","container_readiness_span","naming_register_span","pod_init_span","volume_mount_span:router-volume","volume_mount_span:cpushare-volume","finalizer_delete_span:pod.beta1.sigma.ali/cni-allocated","pod_readiness_span","zappinfo_register_span","total_volume_mount_span"],["PodDelivery","PodDelete","PodDelete","PodCreate","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodDelete","PodCreate","PodDelete","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate"],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[1755063898543,1755063902104,1755063903180,1755063898543,1755063899342,1755063902133,1755063898912,1755063901679,1755063898543,1755063901383,1755063901263,1755063903095,1755063898912,1755063902104,1755063899241,1755063902104,1755063899242,1755063899234,1755063902104,1755063902104,1755063901259,1755063899221,1755063899229,1755063902104,1755063902104,1755063902104,1755063898912],[12383,8822,7747,3560,1916,961,429,425,368,295,120,84,79,20,10,10,2,2,0,0,0,0,0,0,0,0,0]]}}`
		converted := ToTable(trace)
		expected := `{"name":"","Data":[["traceID","spanID","parentSpanID","operationName","serviceName","serviceTags","startTime","duration"],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","bbad2b91-5afd-4b15-9958-b3a0be435cd0",null,"PodDelivery","PodDelivery",null,1755063898543,12383],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","81f5a0e2-758e-40ec-b84e-06cad40c259f","bbad2b91-5afd-4b15-9958-b3a0be435cd0","pod_delete_span","PodDelete",null,1755063902104,8822],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","89da31de-c51a-43b5-9073-3355608cc026","81f5a0e2-758e-40ec-b84e-06cad40c259f","kubelet_delete_span","PodDelete",null,1755063903180,7747],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","c422c90f-ad7b-4813-b265-16f6b611e09c","bbad2b91-5afd-4b15-9958-b3a0be435cd0","pod_ready_span","PodCreate",null,1755063898543,3560],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","3561536f-6e6e-423c-af83-97fd868a43fe","c422c90f-ad7b-4813-b265-16f6b611e09c","sandbox_create_span","PodCreate",null,1755063899342,1916],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","7ac8d072-1674-4cc0-8013-392a865e1460","81f5a0e2-758e-40ec-b84e-06cad40c259f","container_kill_span:test-bvt-container-lvcsuv1v-eu126","PodDelete",null,1755063902133,961],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","ce698f1d-b00a-403b-a42a-eada67cc3cfe","c422c90f-ad7b-4813-b265-16f6b611e09c","ip_allocate_span","PodCreate",null,1755063898912,429],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","b9456e72-4f1f-4915-ad23-e8b587efe3f8","c422c90f-ad7b-4813-b265-16f6b611e09c","pod_running_span","PodCreate",null,1755063901679,425],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","42a1b193-054d-4856-b2c6-a06b75d02791","c422c90f-ad7b-4813-b265-16f6b611e09c","default_schedule_span","PodCreate",null,1755063898543,368],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","ab0993e1-aa0c-4d71-b6a1-ee116c53cfbe","c422c90f-ad7b-4813-b265-16f6b611e09c","container_start_span:test-bvt-container-lvcsuv1v-eu126","PodCreate",null,1755063901383,295],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","9fdb933e-91fb-4400-aebe-355d46f30dcc","c422c90f-ad7b-4813-b265-16f6b611e09c","container_create_span:test-bvt-container-lvcsuv1v-eu126","PodCreate",null,1755063901263,120],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","3e643e5c-608a-4f1f-b41b-71b2acf3cb99","81f5a0e2-758e-40ec-b84e-06cad40c259f","ip_release_span","PodDelete",null,1755063903095,84],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","bff4b56f-d062-4825-ba17-b32834bd9986","c422c90f-ad7b-4813-b265-16f6b611e09c","kubelet_delay_span","PodCreate",null,1755063898912,79],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","a78db90d-0c79-4190-acc8-f47c9538e2c6","81f5a0e2-758e-40ec-b84e-06cad40c259f","finalizer_delete_span:finalizer.k8s.alipay.com/zappinfo","PodDelete",null,1755063902104,20],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","3438e9d2-2b95-4fc9-af6f-7ca784a72baa","c422c90f-ad7b-4813-b265-16f6b611e09c","volume_mount_span:default-token-8f4l2","PodCreate",null,1755063899241,10],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","b52c6728-8b61-4867-b564-b8e05fec1478","81f5a0e2-758e-40ec-b84e-06cad40c259f","finalizer_delete_span:finalizers.k8s.alipay.com/pod-fqdn","PodDelete",null,1755063902104,10],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","8093ebb4-ff37-4b0b-a883-52c308870db2","c422c90f-ad7b-4813-b265-16f6b611e09c","volume_mount_span:shm1","PodCreate",null,1755063899242,2],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","7ef50aa2-9d77-4b72-b926-d9b838ffdd8f","c422c90f-ad7b-4813-b265-16f6b611e09c","volume_mount_span:shm","PodCreate",null,1755063899234,2],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","57cf2d0b-a751-4235-8d13-38613998be64","c422c90f-ad7b-4813-b265-16f6b611e09c","container_readiness_span","PodCreate",null,1755063902104,0],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","b074099f-286d-414f-9097-9222fe0004de","c422c90f-ad7b-4813-b265-16f6b611e09c","naming_register_span","PodCreate",null,1755063902104,0],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","1c76a6ae-156a-463c-b683-6144986987ed","c422c90f-ad7b-4813-b265-16f6b611e09c","pod_init_span","PodCreate",null,1755063901259,0],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","35e9abd7-fbc4-45cc-8480-8b3a39de5e1c","c422c90f-ad7b-4813-b265-16f6b611e09c","volume_mount_span:router-volume","PodCreate",null,1755063899221,0],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","c1097be4-01c4-47c8-9f8c-18b395a99775","c422c90f-ad7b-4813-b265-16f6b611e09c","volume_mount_span:cpushare-volume","PodCreate",null,1755063899229,0],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","0531cafc-1459-4c3c-ae30-3afbd6c4dc71","81f5a0e2-758e-40ec-b84e-06cad40c259f","finalizer_delete_span:pod.beta1.sigma.ali/cni-allocated","PodDelete",null,1755063902104,0],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f1aa3973-ad51-43ea-80b5-944041c69263","c422c90f-ad7b-4813-b265-16f6b611e09c","pod_readiness_span","PodCreate",null,1755063902104,0],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","807bc597-49e9-4d0d-87d9-080e7cc0b672","c422c90f-ad7b-4813-b265-16f6b611e09c","zappinfo_register_span","PodCreate",null,1755063902104,0],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","2b273128-14fe-40b2-bda5-6a63a020b1df","c422c90f-ad7b-4813-b265-16f6b611e09c","total_volume_mount_span","PodCreate",null,1755063898912,0]]}`
		if converted != expected {
			t.Error("GrafanaDataFramesToTable return not expected")
		}
	})

	t.Run("include fields", func(t *testing.T) {
		trace := `{"schema":{"fields":[{"name":"traceID","type":"string"},{"name":"spanID","type":"string"},{"name":"parentSpanID","type":"string"},{"name":"operationName","type":"string"},{"name":"serviceName","type":"string"},{"name":"serviceTags","type":"string"},{"name":"startTime","type":"time"},{"name":"duration","type":"number"}]},"data":{"values":[["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41"],["bbad2b91-5afd-4b15-9958-b3a0be435cd0","81f5a0e2-758e-40ec-b84e-06cad40c259f","89da31de-c51a-43b5-9073-3355608cc026","c422c90f-ad7b-4813-b265-16f6b611e09c","3561536f-6e6e-423c-af83-97fd868a43fe","7ac8d072-1674-4cc0-8013-392a865e1460","ce698f1d-b00a-403b-a42a-eada67cc3cfe","b9456e72-4f1f-4915-ad23-e8b587efe3f8","42a1b193-054d-4856-b2c6-a06b75d02791","ab0993e1-aa0c-4d71-b6a1-ee116c53cfbe","9fdb933e-91fb-4400-aebe-355d46f30dcc","3e643e5c-608a-4f1f-b41b-71b2acf3cb99","bff4b56f-d062-4825-ba17-b32834bd9986","a78db90d-0c79-4190-acc8-f47c9538e2c6","3438e9d2-2b95-4fc9-af6f-7ca784a72baa","b52c6728-8b61-4867-b564-b8e05fec1478","8093ebb4-ff37-4b0b-a883-52c308870db2","7ef50aa2-9d77-4b72-b926-d9b838ffdd8f","57cf2d0b-a751-4235-8d13-38613998be64","b074099f-286d-414f-9097-9222fe0004de","1c76a6ae-156a-463c-b683-6144986987ed","35e9abd7-fbc4-45cc-8480-8b3a39de5e1c","c1097be4-01c4-47c8-9f8c-18b395a99775","0531cafc-1459-4c3c-ae30-3afbd6c4dc71","f1aa3973-ad51-43ea-80b5-944041c69263","807bc597-49e9-4d0d-87d9-080e7cc0b672","2b273128-14fe-40b2-bda5-6a63a020b1df"],[null,"bbad2b91-5afd-4b15-9958-b3a0be435cd0","81f5a0e2-758e-40ec-b84e-06cad40c259f","bbad2b91-5afd-4b15-9958-b3a0be435cd0","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c"],["PodDelivery","pod_delete_span","kubelet_delete_span","pod_ready_span","sandbox_create_span","container_kill_span:test-bvt-container-lvcsuv1v-eu126","ip_allocate_span","pod_running_span","default_schedule_span","container_start_span:test-bvt-container-lvcsuv1v-eu126","container_create_span:test-bvt-container-lvcsuv1v-eu126","ip_release_span","kubelet_delay_span","finalizer_delete_span:finalizer.k8s.alipay.com/zappinfo","volume_mount_span:default-token-8f4l2","finalizer_delete_span:finalizers.k8s.alipay.com/pod-fqdn","volume_mount_span:shm1","volume_mount_span:shm","container_readiness_span","naming_register_span","pod_init_span","volume_mount_span:router-volume","volume_mount_span:cpushare-volume","finalizer_delete_span:pod.beta1.sigma.ali/cni-allocated","pod_readiness_span","zappinfo_register_span","total_volume_mount_span"],["PodDelivery","PodDelete","PodDelete","PodCreate","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodDelete","PodCreate","PodDelete","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate"],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[1755063898543,1755063902104,1755063903180,1755063898543,1755063899342,1755063902133,1755063898912,1755063901679,1755063898543,1755063901383,1755063901263,1755063903095,1755063898912,1755063902104,1755063899241,1755063902104,1755063899242,1755063899234,1755063902104,1755063902104,1755063901259,1755063899221,1755063899229,1755063902104,1755063902104,1755063902104,1755063898912],[12383,8822,7747,3560,1916,961,429,425,368,295,120,84,79,20,10,10,2,2,0,0,0,0,0,0,0,0,0]]}}`
		converted := ToTable(trace, WithIncludeFields("traceID", "operationName", "startTime"))
		expected := `{"name":"","Data":[["traceID","operationName","startTime"],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","PodDelivery",1755063898543],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","pod_delete_span",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","kubelet_delete_span",1755063903180],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","pod_ready_span",1755063898543],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","sandbox_create_span",1755063899342],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","container_kill_span:test-bvt-container-lvcsuv1v-eu126",1755063902133],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","ip_allocate_span",1755063898912],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","pod_running_span",1755063901679],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","default_schedule_span",1755063898543],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","container_start_span:test-bvt-container-lvcsuv1v-eu126",1755063901383],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","container_create_span:test-bvt-container-lvcsuv1v-eu126",1755063901263],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","ip_release_span",1755063903095],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","kubelet_delay_span",1755063898912],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","finalizer_delete_span:finalizer.k8s.alipay.com/zappinfo",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","volume_mount_span:default-token-8f4l2",1755063899241],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","finalizer_delete_span:finalizers.k8s.alipay.com/pod-fqdn",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","volume_mount_span:shm1",1755063899242],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","volume_mount_span:shm",1755063899234],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","container_readiness_span",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","naming_register_span",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","pod_init_span",1755063901259],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","volume_mount_span:router-volume",1755063899221],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","volume_mount_span:cpushare-volume",1755063899229],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","finalizer_delete_span:pod.beta1.sigma.ali/cni-allocated",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","pod_readiness_span",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","zappinfo_register_span",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","total_volume_mount_span",1755063898912]]}`
		if converted != expected {
			t.Error("GrafanaDataFramesToTable return not expected")
		}
	})

	t.Run("exclude fields", func(t *testing.T) {
		trace := `{"schema":{"fields":[{"name":"traceID","type":"string"},{"name":"spanID","type":"string"},{"name":"parentSpanID","type":"string"},{"name":"operationName","type":"string"},{"name":"serviceName","type":"string"},{"name":"serviceTags","type":"string"},{"name":"startTime","type":"time"},{"name":"duration","type":"number"}]},"data":{"values":[["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41"],["bbad2b91-5afd-4b15-9958-b3a0be435cd0","81f5a0e2-758e-40ec-b84e-06cad40c259f","89da31de-c51a-43b5-9073-3355608cc026","c422c90f-ad7b-4813-b265-16f6b611e09c","3561536f-6e6e-423c-af83-97fd868a43fe","7ac8d072-1674-4cc0-8013-392a865e1460","ce698f1d-b00a-403b-a42a-eada67cc3cfe","b9456e72-4f1f-4915-ad23-e8b587efe3f8","42a1b193-054d-4856-b2c6-a06b75d02791","ab0993e1-aa0c-4d71-b6a1-ee116c53cfbe","9fdb933e-91fb-4400-aebe-355d46f30dcc","3e643e5c-608a-4f1f-b41b-71b2acf3cb99","bff4b56f-d062-4825-ba17-b32834bd9986","a78db90d-0c79-4190-acc8-f47c9538e2c6","3438e9d2-2b95-4fc9-af6f-7ca784a72baa","b52c6728-8b61-4867-b564-b8e05fec1478","8093ebb4-ff37-4b0b-a883-52c308870db2","7ef50aa2-9d77-4b72-b926-d9b838ffdd8f","57cf2d0b-a751-4235-8d13-38613998be64","b074099f-286d-414f-9097-9222fe0004de","1c76a6ae-156a-463c-b683-6144986987ed","35e9abd7-fbc4-45cc-8480-8b3a39de5e1c","c1097be4-01c4-47c8-9f8c-18b395a99775","0531cafc-1459-4c3c-ae30-3afbd6c4dc71","f1aa3973-ad51-43ea-80b5-944041c69263","807bc597-49e9-4d0d-87d9-080e7cc0b672","2b273128-14fe-40b2-bda5-6a63a020b1df"],[null,"bbad2b91-5afd-4b15-9958-b3a0be435cd0","81f5a0e2-758e-40ec-b84e-06cad40c259f","bbad2b91-5afd-4b15-9958-b3a0be435cd0","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c"],["PodDelivery","pod_delete_span","kubelet_delete_span","pod_ready_span","sandbox_create_span","container_kill_span:test-bvt-container-lvcsuv1v-eu126","ip_allocate_span","pod_running_span","default_schedule_span","container_start_span:test-bvt-container-lvcsuv1v-eu126","container_create_span:test-bvt-container-lvcsuv1v-eu126","ip_release_span","kubelet_delay_span","finalizer_delete_span:finalizer.k8s.alipay.com/zappinfo","volume_mount_span:default-token-8f4l2","finalizer_delete_span:finalizers.k8s.alipay.com/pod-fqdn","volume_mount_span:shm1","volume_mount_span:shm","container_readiness_span","naming_register_span","pod_init_span","volume_mount_span:router-volume","volume_mount_span:cpushare-volume","finalizer_delete_span:pod.beta1.sigma.ali/cni-allocated","pod_readiness_span","zappinfo_register_span","total_volume_mount_span"],["PodDelivery","PodDelete","PodDelete","PodCreate","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodDelete","PodCreate","PodDelete","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate"],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[1755063898543,1755063902104,1755063903180,1755063898543,1755063899342,1755063902133,1755063898912,1755063901679,1755063898543,1755063901383,1755063901263,1755063903095,1755063898912,1755063902104,1755063899241,1755063902104,1755063899242,1755063899234,1755063902104,1755063902104,1755063901259,1755063899221,1755063899229,1755063902104,1755063902104,1755063902104,1755063898912],[12383,8822,7747,3560,1916,961,429,425,368,295,120,84,79,20,10,10,2,2,0,0,0,0,0,0,0,0,0]]}}`
		converted := ToTable(trace, WithExcludeFields("traceID", "spanID", "parentSpanID", "serviceTags"))
		expected := `{"name":"","Data":[["operationName","serviceName","startTime","duration"],["PodDelivery","PodDelivery",1755063898543,12383],["pod_delete_span","PodDelete",1755063902104,8822],["kubelet_delete_span","PodDelete",1755063903180,7747],["pod_ready_span","PodCreate",1755063898543,3560],["sandbox_create_span","PodCreate",1755063899342,1916],["container_kill_span:test-bvt-container-lvcsuv1v-eu126","PodDelete",1755063902133,961],["ip_allocate_span","PodCreate",1755063898912,429],["pod_running_span","PodCreate",1755063901679,425],["default_schedule_span","PodCreate",1755063898543,368],["container_start_span:test-bvt-container-lvcsuv1v-eu126","PodCreate",1755063901383,295],["container_create_span:test-bvt-container-lvcsuv1v-eu126","PodCreate",1755063901263,120],["ip_release_span","PodDelete",1755063903095,84],["kubelet_delay_span","PodCreate",1755063898912,79],["finalizer_delete_span:finalizer.k8s.alipay.com/zappinfo","PodDelete",1755063902104,20],["volume_mount_span:default-token-8f4l2","PodCreate",1755063899241,10],["finalizer_delete_span:finalizers.k8s.alipay.com/pod-fqdn","PodDelete",1755063902104,10],["volume_mount_span:shm1","PodCreate",1755063899242,2],["volume_mount_span:shm","PodCreate",1755063899234,2],["container_readiness_span","PodCreate",1755063902104,0],["naming_register_span","PodCreate",1755063902104,0],["pod_init_span","PodCreate",1755063901259,0],["volume_mount_span:router-volume","PodCreate",1755063899221,0],["volume_mount_span:cpushare-volume","PodCreate",1755063899229,0],["finalizer_delete_span:pod.beta1.sigma.ali/cni-allocated","PodDelete",1755063902104,0],["pod_readiness_span","PodCreate",1755063902104,0],["zappinfo_register_span","PodCreate",1755063902104,0],["total_volume_mount_span","PodCreate",1755063898912,0]]}`
		if converted != expected {
			t.Error("GrafanaDataFramesToTable return not expected")
		}
	})

	t.Run("rename fields", func(t *testing.T) {
		trace := `{"schema":{"fields":[{"name":"traceID","type":"string"},{"name":"spanID","type":"string"},{"name":"parentSpanID","type":"string"},{"name":"operationName","type":"string"},{"name":"serviceName","type":"string"},{"name":"serviceTags","type":"string"},{"name":"startTime","type":"time"},{"name":"duration","type":"number"}]},"data":{"values":[["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41"],["bbad2b91-5afd-4b15-9958-b3a0be435cd0","81f5a0e2-758e-40ec-b84e-06cad40c259f","89da31de-c51a-43b5-9073-3355608cc026","c422c90f-ad7b-4813-b265-16f6b611e09c","3561536f-6e6e-423c-af83-97fd868a43fe","7ac8d072-1674-4cc0-8013-392a865e1460","ce698f1d-b00a-403b-a42a-eada67cc3cfe","b9456e72-4f1f-4915-ad23-e8b587efe3f8","42a1b193-054d-4856-b2c6-a06b75d02791","ab0993e1-aa0c-4d71-b6a1-ee116c53cfbe","9fdb933e-91fb-4400-aebe-355d46f30dcc","3e643e5c-608a-4f1f-b41b-71b2acf3cb99","bff4b56f-d062-4825-ba17-b32834bd9986","a78db90d-0c79-4190-acc8-f47c9538e2c6","3438e9d2-2b95-4fc9-af6f-7ca784a72baa","b52c6728-8b61-4867-b564-b8e05fec1478","8093ebb4-ff37-4b0b-a883-52c308870db2","7ef50aa2-9d77-4b72-b926-d9b838ffdd8f","57cf2d0b-a751-4235-8d13-38613998be64","b074099f-286d-414f-9097-9222fe0004de","1c76a6ae-156a-463c-b683-6144986987ed","35e9abd7-fbc4-45cc-8480-8b3a39de5e1c","c1097be4-01c4-47c8-9f8c-18b395a99775","0531cafc-1459-4c3c-ae30-3afbd6c4dc71","f1aa3973-ad51-43ea-80b5-944041c69263","807bc597-49e9-4d0d-87d9-080e7cc0b672","2b273128-14fe-40b2-bda5-6a63a020b1df"],[null,"bbad2b91-5afd-4b15-9958-b3a0be435cd0","81f5a0e2-758e-40ec-b84e-06cad40c259f","bbad2b91-5afd-4b15-9958-b3a0be435cd0","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c"],["PodDelivery","pod_delete_span","kubelet_delete_span","pod_ready_span","sandbox_create_span","container_kill_span:test-bvt-container-lvcsuv1v-eu126","ip_allocate_span","pod_running_span","default_schedule_span","container_start_span:test-bvt-container-lvcsuv1v-eu126","container_create_span:test-bvt-container-lvcsuv1v-eu126","ip_release_span","kubelet_delay_span","finalizer_delete_span:finalizer.k8s.alipay.com/zappinfo","volume_mount_span:default-token-8f4l2","finalizer_delete_span:finalizers.k8s.alipay.com/pod-fqdn","volume_mount_span:shm1","volume_mount_span:shm","container_readiness_span","naming_register_span","pod_init_span","volume_mount_span:router-volume","volume_mount_span:cpushare-volume","finalizer_delete_span:pod.beta1.sigma.ali/cni-allocated","pod_readiness_span","zappinfo_register_span","total_volume_mount_span"],["PodDelivery","PodDelete","PodDelete","PodCreate","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodDelete","PodCreate","PodDelete","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate"],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[1755063898543,1755063902104,1755063903180,1755063898543,1755063899342,1755063902133,1755063898912,1755063901679,1755063898543,1755063901383,1755063901263,1755063903095,1755063898912,1755063902104,1755063899241,1755063902104,1755063899242,1755063899234,1755063902104,1755063902104,1755063901259,1755063899221,1755063899229,1755063902104,1755063902104,1755063902104,1755063898912],[12383,8822,7747,3560,1916,961,429,425,368,295,120,84,79,20,10,10,2,2,0,0,0,0,0,0,0,0,0]]}}`
		converted := ToTable(trace, WithExcludeFields("traceID", "spanID", "parentSpanID", "serviceTags"),
			WithRenameFields(map[string]string{
				"operationName": "操作名称Span(operationName)",
				"serviceName":   "Pod阶段(Create/Delete)",
				"duration":      "用时(duration),单位毫秒",
			}))
		expected := `{"name":"","Data":[["操作名称Span(operationName)","Pod阶段(Create/Delete)","startTime","用时(duration),单位毫秒"],["PodDelivery","PodDelivery",1755063898543,12383],["pod_delete_span","PodDelete",1755063902104,8822],["kubelet_delete_span","PodDelete",1755063903180,7747],["pod_ready_span","PodCreate",1755063898543,3560],["sandbox_create_span","PodCreate",1755063899342,1916],["container_kill_span:test-bvt-container-lvcsuv1v-eu126","PodDelete",1755063902133,961],["ip_allocate_span","PodCreate",1755063898912,429],["pod_running_span","PodCreate",1755063901679,425],["default_schedule_span","PodCreate",1755063898543,368],["container_start_span:test-bvt-container-lvcsuv1v-eu126","PodCreate",1755063901383,295],["container_create_span:test-bvt-container-lvcsuv1v-eu126","PodCreate",1755063901263,120],["ip_release_span","PodDelete",1755063903095,84],["kubelet_delay_span","PodCreate",1755063898912,79],["finalizer_delete_span:finalizer.k8s.alipay.com/zappinfo","PodDelete",1755063902104,20],["volume_mount_span:default-token-8f4l2","PodCreate",1755063899241,10],["finalizer_delete_span:finalizers.k8s.alipay.com/pod-fqdn","PodDelete",1755063902104,10],["volume_mount_span:shm1","PodCreate",1755063899242,2],["volume_mount_span:shm","PodCreate",1755063899234,2],["container_readiness_span","PodCreate",1755063902104,0],["naming_register_span","PodCreate",1755063902104,0],["pod_init_span","PodCreate",1755063901259,0],["volume_mount_span:router-volume","PodCreate",1755063899221,0],["volume_mount_span:cpushare-volume","PodCreate",1755063899229,0],["finalizer_delete_span:pod.beta1.sigma.ali/cni-allocated","PodDelete",1755063902104,0],["pod_readiness_span","PodCreate",1755063902104,0],["zappinfo_register_span","PodCreate",1755063902104,0],["total_volume_mount_span","PodCreate",1755063898912,0]]}`
		if converted != expected {
			t.Error("GrafanaDataFramesToTable return not expected")
		}
	})

	t.Run("sort by field asc", func(t *testing.T) {
		trace := `{"schema":{"fields":[{"name":"traceID","type":"string"},{"name":"spanID","type":"string"},{"name":"parentSpanID","type":"string"},{"name":"operationName","type":"string"},{"name":"serviceName","type":"string"},{"name":"serviceTags","type":"string"},{"name":"startTime","type":"time"},{"name":"duration","type":"number"}]},"data":{"values":[["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41"],["bbad2b91-5afd-4b15-9958-b3a0be435cd0","81f5a0e2-758e-40ec-b84e-06cad40c259f","89da31de-c51a-43b5-9073-3355608cc026","c422c90f-ad7b-4813-b265-16f6b611e09c","3561536f-6e6e-423c-af83-97fd868a43fe","7ac8d072-1674-4cc0-8013-392a865e1460","ce698f1d-b00a-403b-a42a-eada67cc3cfe","b9456e72-4f1f-4915-ad23-e8b587efe3f8","42a1b193-054d-4856-b2c6-a06b75d02791","ab0993e1-aa0c-4d71-b6a1-ee116c53cfbe","9fdb933e-91fb-4400-aebe-355d46f30dcc","3e643e5c-608a-4f1f-b41b-71b2acf3cb99","bff4b56f-d062-4825-ba17-b32834bd9986","a78db90d-0c79-4190-acc8-f47c9538e2c6","3438e9d2-2b95-4fc9-af6f-7ca784a72baa","b52c6728-8b61-4867-b564-b8e05fec1478","8093ebb4-ff37-4b0b-a883-52c308870db2","7ef50aa2-9d77-4b72-b926-d9b838ffdd8f","57cf2d0b-a751-4235-8d13-38613998be64","b074099f-286d-414f-9097-9222fe0004de","1c76a6ae-156a-463c-b683-6144986987ed","35e9abd7-fbc4-45cc-8480-8b3a39de5e1c","c1097be4-01c4-47c8-9f8c-18b395a99775","0531cafc-1459-4c3c-ae30-3afbd6c4dc71","f1aa3973-ad51-43ea-80b5-944041c69263","807bc597-49e9-4d0d-87d9-080e7cc0b672","2b273128-14fe-40b2-bda5-6a63a020b1df"],[null,"bbad2b91-5afd-4b15-9958-b3a0be435cd0","81f5a0e2-758e-40ec-b84e-06cad40c259f","bbad2b91-5afd-4b15-9958-b3a0be435cd0","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c"],["PodDelivery","pod_delete_span","kubelet_delete_span","pod_ready_span","sandbox_create_span","container_kill_span:test-bvt-container-lvcsuv1v-eu126","ip_allocate_span","pod_running_span","default_schedule_span","container_start_span:test-bvt-container-lvcsuv1v-eu126","container_create_span:test-bvt-container-lvcsuv1v-eu126","ip_release_span","kubelet_delay_span","finalizer_delete_span:finalizer.k8s.alipay.com/zappinfo","volume_mount_span:default-token-8f4l2","finalizer_delete_span:finalizers.k8s.alipay.com/pod-fqdn","volume_mount_span:shm1","volume_mount_span:shm","container_readiness_span","naming_register_span","pod_init_span","volume_mount_span:router-volume","volume_mount_span:cpushare-volume","finalizer_delete_span:pod.beta1.sigma.ali/cni-allocated","pod_readiness_span","zappinfo_register_span","total_volume_mount_span"],["PodDelivery","PodDelete","PodDelete","PodCreate","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodDelete","PodCreate","PodDelete","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate"],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[1755063898543,1755063902104,1755063903180,1755063898543,1755063899342,1755063902133,1755063898912,1755063901679,1755063898543,1755063901383,1755063901263,1755063903095,1755063898912,1755063902104,1755063899241,1755063902104,1755063899242,1755063899234,1755063902104,1755063902104,1755063901259,1755063899221,1755063899229,1755063902104,1755063902104,1755063902104,1755063898912],[12383,8822,7747,3560,1916,961,429,425,368,295,120,84,79,20,10,10,2,2,0,0,0,0,0,0,0,0,0]]}}`
		converted := ToTable(trace, WithIncludeFields("traceID", "operationName", "startTime"),
			WithSortByField("startTime", false))
		expected := `{"name":"","Data":[["traceID","operationName","startTime"],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","PodDelivery",1755063898543],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","pod_ready_span",1755063898543],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","default_schedule_span",1755063898543],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","ip_allocate_span",1755063898912],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","kubelet_delay_span",1755063898912],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","total_volume_mount_span",1755063898912],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","volume_mount_span:router-volume",1755063899221],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","volume_mount_span:cpushare-volume",1755063899229],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","volume_mount_span:shm",1755063899234],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","volume_mount_span:default-token-8f4l2",1755063899241],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","volume_mount_span:shm1",1755063899242],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","sandbox_create_span",1755063899342],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","pod_init_span",1755063901259],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","container_create_span:test-bvt-container-lvcsuv1v-eu126",1755063901263],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","container_start_span:test-bvt-container-lvcsuv1v-eu126",1755063901383],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","pod_running_span",1755063901679],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","pod_delete_span",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","finalizer_delete_span:finalizer.k8s.alipay.com/zappinfo",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","finalizer_delete_span:finalizers.k8s.alipay.com/pod-fqdn",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","container_readiness_span",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","naming_register_span",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","finalizer_delete_span:pod.beta1.sigma.ali/cni-allocated",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","pod_readiness_span",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","zappinfo_register_span",1755063902104],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","container_kill_span:test-bvt-container-lvcsuv1v-eu126",1755063902133],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","ip_release_span",1755063903095],["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","kubelet_delete_span",1755063903180]]}`
		if converted != expected {
			t.Error("GrafanaDataFramesToTable return not expected")
		}
	})

	t.Run("sort by field desc with rename fields", func(t *testing.T) {
		trace := `{"schema":{"fields":[{"name":"traceID","type":"string"},{"name":"spanID","type":"string"},{"name":"parentSpanID","type":"string"},{"name":"operationName","type":"string"},{"name":"serviceName","type":"string"},{"name":"serviceTags","type":"string"},{"name":"startTime","type":"time"},{"name":"duration","type":"number"}]},"data":{"values":[["f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41","f3dc2471-8dba-4ed8-a4c5-8965f7561f41"],["bbad2b91-5afd-4b15-9958-b3a0be435cd0","81f5a0e2-758e-40ec-b84e-06cad40c259f","89da31de-c51a-43b5-9073-3355608cc026","c422c90f-ad7b-4813-b265-16f6b611e09c","3561536f-6e6e-423c-af83-97fd868a43fe","7ac8d072-1674-4cc0-8013-392a865e1460","ce698f1d-b00a-403b-a42a-eada67cc3cfe","b9456e72-4f1f-4915-ad23-e8b587efe3f8","42a1b193-054d-4856-b2c6-a06b75d02791","ab0993e1-aa0c-4d71-b6a1-ee116c53cfbe","9fdb933e-91fb-4400-aebe-355d46f30dcc","3e643e5c-608a-4f1f-b41b-71b2acf3cb99","bff4b56f-d062-4825-ba17-b32834bd9986","a78db90d-0c79-4190-acc8-f47c9538e2c6","3438e9d2-2b95-4fc9-af6f-7ca784a72baa","b52c6728-8b61-4867-b564-b8e05fec1478","8093ebb4-ff37-4b0b-a883-52c308870db2","7ef50aa2-9d77-4b72-b926-d9b838ffdd8f","57cf2d0b-a751-4235-8d13-38613998be64","b074099f-286d-414f-9097-9222fe0004de","1c76a6ae-156a-463c-b683-6144986987ed","35e9abd7-fbc4-45cc-8480-8b3a39de5e1c","c1097be4-01c4-47c8-9f8c-18b395a99775","0531cafc-1459-4c3c-ae30-3afbd6c4dc71","f1aa3973-ad51-43ea-80b5-944041c69263","807bc597-49e9-4d0d-87d9-080e7cc0b672","2b273128-14fe-40b2-bda5-6a63a020b1df"],[null,"bbad2b91-5afd-4b15-9958-b3a0be435cd0","81f5a0e2-758e-40ec-b84e-06cad40c259f","bbad2b91-5afd-4b15-9958-b3a0be435cd0","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","81f5a0e2-758e-40ec-b84e-06cad40c259f","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c","c422c90f-ad7b-4813-b265-16f6b611e09c"],["PodDelivery","pod_delete_span","kubelet_delete_span","pod_ready_span","sandbox_create_span","container_kill_span:test-bvt-container-lvcsuv1v-eu126","ip_allocate_span","pod_running_span","default_schedule_span","container_start_span:test-bvt-container-lvcsuv1v-eu126","container_create_span:test-bvt-container-lvcsuv1v-eu126","ip_release_span","kubelet_delay_span","finalizer_delete_span:finalizer.k8s.alipay.com/zappinfo","volume_mount_span:default-token-8f4l2","finalizer_delete_span:finalizers.k8s.alipay.com/pod-fqdn","volume_mount_span:shm1","volume_mount_span:shm","container_readiness_span","naming_register_span","pod_init_span","volume_mount_span:router-volume","volume_mount_span:cpushare-volume","finalizer_delete_span:pod.beta1.sigma.ali/cni-allocated","pod_readiness_span","zappinfo_register_span","total_volume_mount_span"],["PodDelivery","PodDelete","PodDelete","PodCreate","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodDelete","PodCreate","PodDelete","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodCreate","PodDelete","PodCreate","PodCreate","PodCreate"],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[1755063898543,1755063902104,1755063903180,1755063898543,1755063899342,1755063902133,1755063898912,1755063901679,1755063898543,1755063901383,1755063901263,1755063903095,1755063898912,1755063902104,1755063899241,1755063902104,1755063899242,1755063899234,1755063902104,1755063902104,1755063901259,1755063899221,1755063899229,1755063902104,1755063902104,1755063902104,1755063898912],[12383,8822,7747,3560,1916,961,429,425,368,295,120,84,79,20,10,10,2,2,0,0,0,0,0,0,0,0,0]]}}`
		converted := ToTable(trace, WithIncludeFields("operationName", "serviceName", "startTime", "duration"),
			WithSortByField("startTime", true),
			WithRenameFields(map[string]string{
				"operationName": "操作名称Span(operationName)",
				"serviceName":   "Pod阶段(Create/Delete)",
				"duration":      "用时(duration),单位毫秒",
			}))
		expected := `{"name":"","Data":[["操作名称Span(operationName)","Pod阶段(Create/Delete)","startTime","用时(duration),单位毫秒"],["kubelet_delete_span","PodDelete",1755063903180,7747],["ip_release_span","PodDelete",1755063903095,84],["container_kill_span:test-bvt-container-lvcsuv1v-eu126","PodDelete",1755063902133,961],["pod_delete_span","PodDelete",1755063902104,8822],["finalizer_delete_span:finalizer.k8s.alipay.com/zappinfo","PodDelete",1755063902104,20],["finalizer_delete_span:finalizers.k8s.alipay.com/pod-fqdn","PodDelete",1755063902104,10],["container_readiness_span","PodCreate",1755063902104,0],["naming_register_span","PodCreate",1755063902104,0],["finalizer_delete_span:pod.beta1.sigma.ali/cni-allocated","PodDelete",1755063902104,0],["pod_readiness_span","PodCreate",1755063902104,0],["zappinfo_register_span","PodCreate",1755063902104,0],["pod_running_span","PodCreate",1755063901679,425],["container_start_span:test-bvt-container-lvcsuv1v-eu126","PodCreate",1755063901383,295],["container_create_span:test-bvt-container-lvcsuv1v-eu126","PodCreate",1755063901263,120],["pod_init_span","PodCreate",1755063901259,0],["sandbox_create_span","PodCreate",1755063899342,1916],["volume_mount_span:shm1","PodCreate",1755063899242,2],["volume_mount_span:default-token-8f4l2","PodCreate",1755063899241,10],["volume_mount_span:shm","PodCreate",1755063899234,2],["volume_mount_span:cpushare-volume","PodCreate",1755063899229,0],["volume_mount_span:router-volume","PodCreate",1755063899221,0],["ip_allocate_span","PodCreate",1755063898912,429],["kubelet_delay_span","PodCreate",1755063898912,79],["total_volume_mount_span","PodCreate",1755063898912,0],["PodDelivery","PodDelivery",1755063898543,12383],["pod_ready_span","PodCreate",1755063898543,3560],["default_schedule_span","PodCreate",1755063898543,368]]}`
		if converted != expected {
			t.Error("GrafanaDataFramesToTable return not expected")
		}
	})
}
